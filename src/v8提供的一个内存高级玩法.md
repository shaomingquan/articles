---
date: 2020-11-28
tags: javascript
---

WeakMapæä¾›äº†å¼±å¼•ç”¨ï¼Œä¸è¿‡æ¯•ç«Ÿä»…ä»…å±€é™åœ¨Mapï¼Œåæ¥åˆæœ‰äº†WeakRefï¼Œ[è¿™é‡Œè¯´çš„å¾ˆè¯¦ç»†](https://v8.dev/features/weak-references)ï¼ŒåŸºäºå®˜æ–¹ç»™çš„ä¾‹å­ï¼Œä»…ä»…æ€»ç»“ä¸‹é‡ç‚¹ï¼š

- å¯å¯¹ä»»æ„å˜é‡å¼±å¼•ç”¨ï¼ˆWeakRefï¼‰
- åŠ å…¥äº†åƒåœ¾å›æ”¶å›è°ƒï¼ˆFinalizationRegistryï¼‰

è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ**é™ä½é—æ¼æ‰‹åŠ¨å›æ”¶å¯¼è‡´å†…å­˜æ³„éœ²çš„é£é™©**ã€‚é—®é¢˜ç®€è¿°ï¼š

```js
class MovingAvg {
  constructor(socket) {
    this.events = [];
    this.socket = socket;
    this.listener = (ev) => { this.events.push(ev); };
    socket.addEventListener('message', this.listener);
  }

  compute(n) {
    // Compute the simple moving average for the last n events.
    // â€¦
  }
}
```

ä¸Šé¢çš„socketé€šè¿‡ä¸€ä¸ª`closure`refäº†`MovingAvg`å®ä¾‹ï¼Œå¯èƒ½å¯¹äºå¾ˆå¤šjsæ–°æ‰‹ï¼Œè¿™æ˜¯ä¸€ä¸ªæ¯”è¾ƒéšè”½çš„refã€‚ç„¶åä¸‹é¢çš„è¿™ä¸ªç±»ä½¿ç”¨äº†è¿™ä¸ªç±»ï¼š

```js
class MovingAvgComponent {
  constructor(socket) {
    this.socket = socket;
  }

  start() {
    this.movingAvg = new MovingAvg(this.socket);
  }

  stop() {
    // Allow the garbage collector to reclaim memory.
    this.movingAvg = null;
  }

  render() {
    // Do rendering.
    // â€¦
  }
}
```

stopçœ‹ä¼¼æ¸…ç†äº†`MovingAvg`ï¼Œå®é™…ä¸Šæ²¡æœ‰ï¼Œsocketè¿˜é€šè¿‡ä¿æŒä¸€ä¸ªclosureå¼•ç”¨äº†å½“å‰çš„`MovingAvg`å®ä¾‹ã€‚é‚£ä¹ˆåŠ ä¸ª`dispose`å§ï¼š

```js
class MovingAvgComponent {
  constructor(socket) {
    this.socket = socket;
  }

  start() {
    this.movingAvg = new MovingAvg(this.socket);
  }

  stop() {
    // Allow the garbage collector to reclaim memory.
    this.movingAvg.dispose()
    this.movingAvg = null;
  }

  render() {
    // Do rendering.
    // â€¦
  }
}

class MovingAvg {
  constructor(socket) {
    this.events = [];
    this.socket = socket;
    this.listener = (ev) => { this.events.push(ev); };
    socket.addEventListener('message', this.listener);
  }

  dispose() {
    this.socket.removeEventListener('message', this.listener);
  }

  // â€¦
}
```

é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œæ¸…ç†`MovingAvg`å®ä¾‹éœ€è¦ä¸¤æ­¥èµ°ï¼š

1. `this.movingAvg.dispose()`
2. `this.movingAvg = null`

**æ‰€ä»¥æ¸…ç†æ­¥éª¤çš„é£é™©å°±å˜å¤§äº†**ã€‚æˆ–è®¸å¯¹äºæŸäº›äººæ¥è¯´ä¸èƒ½ç®—æ˜¯é—®é¢˜ï¼Œè€Œä¸”æ¯•ç«Ÿï¼Œå³ä½¿æ¸…ç†åªéœ€è¦ä¸€æ­¥ï¼Œè¿˜æ˜¯ä¼šæœ‰äººçŠ¯é”™ã€‚ä½†æ¯•ç«Ÿv8æ˜¯æåº•å±‚çš„äº†ï¼Œè§£å†³æœºåˆ¶æ€§é—®é¢˜å°±æ˜¯å®ƒçš„å·¥ä½œã€‚`WeakRef`æ¥è§£å†³ï¼š

```js
function addWeakListener(socket, listener) {
  const weakRef = new WeakRef(listener);
  const wrapper = (ev) => { weakRef.deref()?.(ev); };
  socket.addEventListener('message', wrapper);
}

class MovingAvg {
  constructor(socket) {
    this.events = [];
    this.listener = (ev) => { this.events.push(ev); };
    addWeakListener(socket, this.listener);
  }
}
```

`const weakRef = new WeakRef(listener);`å»ºç«‹äº†å¼±refå…³ç³»ï¼Œå¦‚æœlistenerè¢«å›æ”¶äº†ï¼Œrefå…³ç³»å°±è§£é™¤äº†`weakRef.deref()`å°±è¿”å›`undefined`ã€‚ä¸è¿‡`wrapper`æ²¡æœ‰ç”¨äº†ï¼Œå®ƒä¹Ÿéœ€è¦è¢«å›æ”¶ã€‚`FinalizationRegistry`æ¥è§£å†³ï¼Œæ•´ä¸ªä¸€å¥—é•¿è¿™æ ·çš„ï¼š

```js
const gListenersRegistry = new FinalizationRegistry(({ socket, wrapper }) => {
  socket.removeEventListener('message', wrapper); // 6
});

function addWeakListener(socket, listener) {
  const weakRef = new WeakRef(listener); // 2
  const wrapper = (ev) => { weakRef.deref()?.(ev); }; // 3
  gListenersRegistry.register(listener, { socket, wrapper }); // 4
  socket.addEventListener('message', wrapper); // 5
}

class MovingAvg {
  constructor(socket) {
    this.events = [];
    this.listener = (ev) => { this.events.push(ev); }; // 1
    addWeakListener(socket, this.listener);
  }
}
```

æ•´ä¸ªè¿‡ç¨‹ï¼Œè¿˜æ˜¯å»ºè®®çœ‹çœ‹v8çš„åŸæ–‡è§£é‡ŠğŸ‘‡ï¼š

> We make an event listener and assign it to this.listener so that it is strongly referenced by the MovingAvg instance (1). We then wrap the event listener that does the work in a WeakRef to make it garbage-collectible, and to not leak its reference to the MovingAvg instance via this (2). We make a wrapper that deref the WeakRef to check if it is still alive, then call it if so (3). We register the inner listener on the FinalizationRegistry, passing a holding value { socket, wrapper } to the registration (4). We then add the returned wrapper as an event listener on socket (5). Sometime after the MovingAvg instance and the inner listener are garbage-collected, the finalizer may run, with the holding value passed to it. Inside the finalizer, we remove the wrapper as well, making all memory associated with the use of a MovingAvg instance garbage-collectible (6).

æ³¨æ„äº‹é¡¹ï¼š

- FinalizationRegistry
    - å®ƒå¾—æ˜¯ä¸ªå…¨å±€å˜é‡ï¼Œå®ƒå¾—è´Ÿè´£å›æ”¶åˆ«äººï¼Œè‡ªå·±åˆ«è¢«å›æ”¶äº†
    - å›è°ƒæ‰§è¡Œçš„æ—¶æœºé¡ºåºéƒ½ä¸ç¡®å®šï¼Œä¸è¦æ”¾é‡è¦é€»è¾‘åœ¨é‡Œé¢
- é˜²æ­¢ä¸€äº›å¾®å¦™çš„closure refï¼ŒaddWeakListeneræ”¾åœ¨constructorçš„å¤–é¢