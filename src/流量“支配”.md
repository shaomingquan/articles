---
date: 2020-02-01
tags: 软件
---

> 我在开发工作中使用过一些流量工具，它们对流量做了一些处理，在很多实际的场景中发挥了很大的作用。

### 翻墙

假设有台pc ping不同google，那么找个服务器，这个服务器：

- 1，能ping通google
- 2，能ping通这台pc

上面装一个某某协议的代理服务，在pc上装个某某协议的客户端，链接这个代理服务，搞定

如果一个非科班的朋友对网络代理略有耳闻，我想绝大部分情况是通过翻墙了解的

### 反向代理

在翻墙中我们说的代理是代理客户端，反向代理则是代理服务器，常用于：

- 1，负载均衡
- 2，服务分流
- 3，....

Nginx就是这样的一个工具。通常作为流量的入口，对不同域名不同path的流量分配不同的集群。

当然这也不是Nginx的专属，我理解：**如果这个流量最终不是由当前节点处理的，那么它就是它的upstream的反向代理。**

### 域名欺骗

篡改host文件，可以让你本机的任何域名解析到任何服务，本质上还是把域名解析的过程拦截了。

还有更好的方法。我经常使用的Proxy SwitchyOmega，他在域名解析之前拦截流量，好处是：

- 1，使用pac脚本，可以代理**path粒度**的流量到**端口粒度**的服务，相比修改host文件则是域名粒度 => IP粒度
- 2，浏览器调试非常方便，观察remote address就可以看到流量的真实去处

在实际研发调试过程中的作用：

- 1，代理任何api到任何其他人的机器，方便调试
- 2，服务迁移验证

### 流量篡改

在一些场景下我们希望对request response进行篡改以调试。

- 1，修改响应头，调试响应头对浏览器的影响，反之请求头对服务端的影响
- 2，弱网模拟
- 3，无法inspect的情况下的抓包
- 4，流量分流
- 5，流量重放
- 6，https抓包

Charles是一个强大的工具，它可以做到上面的事情，像分流，可能做不到像用Proxy SwitchyOmega那么直观，不过也可以做。

它最强大的是对于那些不能inspect的用户代理的抓包，如移动端，pc端特定环境的页面。

> 给不能inspect的的用户代理装一个inspector？请看 https://github.com/liriliri/eruda 或者 https://github.com/Tencent/vConsole，它们很有用，但是 1）不能完全取代Charles，2）对页面多少有副作用，尤其移动端的web是很脆弱的。一般来讲还是会选择usb调试、虚拟机，或者类似 https://github.com/wuchangming/spy-debugger 的工具。

### 流量重放

Charles能做流量重放，那这一条为啥单拎出来？为了安利Postman。

对于已经被抓取的包，为了方便后续的调试，可以这样操作：

- 1，在Charles上导出curl脚本
- 2，在Postman上导入curl脚本

这样对于重放流量的体验是最好的。另外还有人写了这样的中间件，直接在调试server过程中在console中打印，就很方便，我这边用一个开源的代码改造的，开源代码：

- https://github.com/wlodzislav/request2curl/blob/master/index.js