---
date: 2022-03-29
tags: nodejs
---

### 问题

最近团队内部抛出一个问题，发现自己掌握的也比较模糊，所以又review了一下koa-router的实现，问题是：

发现bff上有人写了两个一模一样的router，其他同事在维护的时候，准备清理一下代码，所以想删除其中一个，这时候应该删前面的还是后面的？

### 分析

对于这种声明式的冲突问题，可能需要具体问题具体分析：

在我们熟悉的JavaScript中，存在函数声明和变量声明，如果使用var以及老式的函数声明方式，后面的会取代前面的。通过分析koa-router的源码不难看出，**koa会收集所有的定义，并在运行时，筛选出所有能匹配上的定义**，所以其实koa-router的行为是：

***对于多个相同的router声明，koa-router都不会忽视***，虽然说是都不会忽视，但因为其实在大部分koa应用中，我们写的大部分逻辑都是在末端写的（最终处理请求并返回，不会`await next()`），即便是匹配了多个，因为很多情况下前面的没有`await next()`，所以后面的不会执行。现象就是后声明的被忽略的，但正如上文所说，这种理解是比较片面的。

这种设计很灵活，比如要给一个特定的路由加一个post逻辑（后置逻辑），那只需要在该路由声明的后面再声明同一个路由，然后在原路由内部`await next()`即可。但我们需要约定好这类逻辑该怎么写，设想下如果两段相隔八千里的代码能控制同一个业务，那属实比较诡异了。

### 建议

- 无特殊倾向，在controller中（也就是最末端的），不使用`await next()`。
- 对于router可以规范”生命周期“，比如preController，postController。
- 可以严格控制每次匹配router的个数，在开发阶段，如果存在两个则给出warning。
- 其他，见：[koa路由优化思路](https://github.com/shaomingquan/articles/blob/master/src/koa%E8%B7%AF%E7%94%B1%E4%BC%98%E5%8C%96%E6%80%9D%E8%B7%AF.md)。