> 工作也有三年了，自己曾较深度的做过三个数据相关的产品，虽然是断续的三段经验，但是他们还是很有共性的。复盘一下，趁着还没忘干净。

## 数据产品的核心组件

- 上报sdk：
    - 也有可能没有上报sdk，直接从一众日志，或者现成的队列里拿数据。
- 数据处理：
    - 包括数据清洗，数据的分布式计算。
    - 本质上是某种方式的离线数据或者实时数据转换成某种方式的在线数据，在线数据保证了查询的速度。核心是时间和冗余换查询速度的思想。
- 数据展示：
    - 选择合适的可视化组件。

## 上报sdk

一般来讲分为两种sdk：

- 用户行为上报。
- 性能指标上报。

其实他们在前端的大概实现思路是一致的，那为什么要分开做呢？

- 一般来事件监控跟性能监控不是同一波人维护的。
- 性能数据几乎不需要自定义维度，事件监控几乎都有自定义维度，它是一种业务数据。
- 性能数据可能需要采样，事件监控几乎不采样。
- 性能指标可通过指标名自定义聚合方法，它支持传值（比如ttfb为300ms）。事件监控其实就是简单的累加，但实际上它的产品形态更复杂，这个后面再说。

### 上报sdk通用技术点

5日志上报sdk的一些通用的需要注意的点。

1）找一种跨域的上报方式

因为数据服务往往不与网站主体同域名，不占并发，也容易统一管理。

- 使用动态插入的img标签`/_.gif?`。
- 使用cors。

2）对于退出事件的处理

因为退出时的请求失败率很高，需要些特殊的手段，或者折中方案。

- [sendBeacon](https://developer.mozilla.org/en-US/docs/Web/API/Navigator/sendBeacon)。This method addresses the needs of analytics and diagnostics code that typically attempts to send data to a web server prior to the unloading of the document. 
- 使用jsBridge交给native上传。
- 使用替代模型达到同样的数据表达效果。

最后一点需要解释一下。这是我在mt时候用过的一个方案，大家接受度也比较高，但也勉强把它算作一种折中吧。页面加载后的第5s 10s 30s 60s 分别打点，收集到的打点次数这里标记为t5，t10等。然后画一个频度分布直方图，从左到右分别是pv-t5，t5-t10，t30-t10，t60-t30，t60。这个图可以直观的反应页面停留效果，左高右低效果不好，右边较高说明效果较好。绕过了退出问题，也提供了一个更好的可视化模型，确定是用户上报了好几次，费公司的流量。

3）navigation-timing

主要参考[navigation-timing](https://www.w3.org/TR/navigation-timing/)，也需要参考一些约定，甚至公司内的黑话（可能稍有不同），比如我们这边是这样定义的。

4）加载代码，版本控制

- 不同业务方的诉求不同，有的希望稳重些，他们会固定版本，有的希望激进些，版本是latest。
- 一般来说加载都是异步的形式，这就要求加载代码中最好自带一个buffer，等真正的sdk加载之后再flush。
