---
date: 2019-09-25
tags: 软件
---

## 背景

某个业务要从老系统下线了，功能会迁移到一个新平台。方式是前端这边需要使用BFF模式支持新的template层和view层，服务由后端提供通过RPC提供。

系统重构不在话下，无论是ui还是交互提升还是很大的，不过上线的时候着实暴露出太多的问题，有些是流程规范的问题，有些是技术的问题。

### 问题起源

这个业务虽然是老系统上的，但实际上已经有一个新的平台承载了很多类似的业务，所以说这个业务理应放在这个平台。然而，所有人都没有意识到这一点，知道我准备要域名和sso_id的时候，大佬们觉得要跟已有的平台结合，没必要申请新的平台。

这个变数衍生了一系列工作，也衍生一系列坑。

### 新的工作：兼容代码

因为各个前端系统目前没有一个统一的通信规范，网络lib对后端数据以及错误处理没有一个adapter层做统一，所以当我把我的业务移植到那个平台时，在业务代码中就出现了数据格式不兼容的问题。

我本着不动基础lib的原则，还是把我自己的业务代码兼容了新平台的网络lib，同时在我的node层也对返回值做了统一的封装。

> 前端需要有一个统一的网络lib，提供标准的adapter层interface来兼容不同的服务端格式，只需要实现不同的adapter来做兼容即可。

### 新的工作：授权重构

因为我提前已经用node实现了view层，这个view层重新用新平台的java实现成本很大，商榷结果是代理某个path前缀的流量到node服务上，因为不走他们的java服务了，所以带回来的token就要请求一下java服务来校验。

这块出现的一个非常奇怪的问题是，当我登陆到线上机器时，ping那个java给的鉴权接口，始终是404，这个问题到现在我也不知道为啥。因为node和java在同一台机器上，无奈我在线上模式直接使用localhost，这样就好了。

> 其实公司这边的Oauth也是有一定问题的，这里不展开了。

### 第一类坑：外部资源获取问题

这几个线上服务器有点特殊，感觉公司的标准域名服务在这里就不生效了，所以挨个配了host。以及数据库也不行了，由于我只需要读数据库，所以懒得跟dba扯皮，直接把ro的用户替上去了。

> 体验过才知道，还是标准镜像+无状态实例+SaaS这种的爽呀！

### 第二类坑：程序本身出现环境不兼容

我还是第一次遇到lib环境的问题，在线上那台机器上bcrypt这个包就build不了了，反正就差点啥，巧的是我恰好不用这个，踢出去就解决了，但这个确实比较吓人。

> docker就很重要了，通过docker层抹平线上和线下的环境差别，可以让线上问题提早暴露提早修复。nodejs版本不同步的问题也可以轻易解决，这种事出问题就是大问题，还是要提前发现呀。

每次上线pm2就跪一次，这个有点诡异，至今不知道啥原因。

### 差点出大问题：半吊子需求分析

这个业务是有一批用户的，然而我们只调研了一组用户的需求，后来发现还有另外一波用户，傻眼了，还好也可以覆盖这些同事的需求，也算

> 这时候记录用户log就很重要了，迁移的时候从log里把用户拉出来，要是用某跳动的IM产品甚至直接就把群拉出来了。

## 感想

见微知著，虽然现实中往往小修小补，然后不问后事，但是要对规模性问题有预案。做产品的意识，服务意识也要加强。