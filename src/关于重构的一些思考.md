---
date: 2022-05-04
tags: 思考
---

> 最近在组织一个项目的“拯救”工作，有不少思考，记录一下

分以下几个部分：

- 一个项目是怎么一步一步的变质的
- 重构是啥
- 如何拯救

## 一个项目是怎么一步一步的变质的

### 项目周期长

时间短甚至来不及犯错误

### 人员组织松散

一个跨团队的中台，一些内部系统，用户是中台团队（审核，销售），研发又是来自各个业务线的。谁都来添一笔，大家又没什么沟通，干完就跑

### 没有固定的负责人

人员调整频繁，不重视交接，文档全靠临时抱佛脚，人都要跑了，指望不了他文档能补的多认真

### 只重视短期效率，有一些sb制度

精致的人效，业绩几个最sb的政策：按单位时间代码行数评估程序员人效。按bug量背锅，不给任何容错空间，补丁叠补丁最安全，重构是什么？有风险，不干

> 我们应该重视人效，但没必要那么“精致”

### 程序员自身素质问题

如果上面的一些客观阻碍都没有，那么只能是技术团队自己的问题了，上级不重视，下级摆烂

> 就我目前负责的这个项目而言，一直以来这个项目就如一个皮球被踢来踢去。19年的时候是一个单兵能力很强的研发0～1的，用了一套经典的react+node，后来另一个同学开始负责（此时我偶尔插进来写一些需求），当时是前后端1v1，那个后端吧，排期已经到两个月之后了，后端不给封装rpc，为了需求能交付，此时前端直接开始读写mysql（同一个表，两个没啥沟通的程序员并发搞，心有多大？）。后来很长一段时间内都没有固定的负责人，大家谁想加点啥完全没有章法，全体“结果导向”，但好在都是业务线自己的需求，比较规范，后端给足了rpc。后来大前端招了一个同学专门接这块的需求，但感觉这哥们并不开心，果然两个月润了。最近呢，公司老前端对这块比较熟悉的就是我了，所以就开始研究改造了。像一个皮球被踢来踢去。

## 重构是啥

重构就是：在不改变代码代码***外在行为***的前提下，对代码作出修改以改进程序的***内部结构***，目标是***保持代码易读易***修改

- 重构是一个比较主观的事，极端情况下，对于人效，质量毫不在意，那重构永远不会发生
- 重构不应该是一种“软件生命周期”，理想状态下，是在迭代的过程中按需开展的，并不会对排期产生质的影响。如果说有人需要一两天的时间完成一次重构，那大概率已经存在很大的问题了。

> 所以说我要做的其实不算重构，算是解决问题

## 如何拯救

### 管理机制

1. 同系列项目安排固定负责人

诚然，我们不能要求每个同学固定负责某个项目，因为项目实际需求问题，如果需求产生断档，人效就严重不饱和。我们公司的方案就是让一个大约4～5人的小组负责一系列项目，再由负责人统一把控。

2. 调整思维，以发展的眼光看架构

不指望一开始就获得一个最完善的架构，一些从实际需求出发，除非是：

- 已经可以预见到的需求（比如说crm中的低代码设计，从一开始就能定下来了）
- 非功能性需求不达标，qps，延迟，安全性等等

3. 明确跨团队协作的职责

- 平行协作：中台团队尽量别管业务方的事
- 垂直协作：bff究竟该做什么？这次在node持久化，下次又后端做持久化，谁方便谁来

4. 团队有共识

重构不是技术问题，是经济问题

认可重构带来的长期价值，重要的是大佬认可

5. 使用技术强化管理机制

- git（git flow，或者自定义一些规范，是chunk-base还是feature base？）
- 微服务（中台和业务方拆的更好了）

> 拆分或者融合，看似是技术问题，背后是管理机制，而技术则辅助管理机制更流畅的运行。“强化”的价值应该被重视

### 纯技术手段

1. 项目已经太烂了，一些高roi的应急手段：

- 增加trace功能，项目内部调用链路一目了然，bff有奇效
- 无用代码移除：
    - 使用一些基于编译原理的DCE技术，如tree-shaking
    - 使用代码检测工具，如sonarcube，检测代码重复率，以及一些代码“坏味道”
    - 分析日志&与业务方沟通，下线一些老旧业务

2. 多写test

没有test，重构难进行，test帮助我们确认代码的行为未改变

3. 组织学习重构原则，重构技巧

原则：

- 大原则：如果你要给程序添加一个特性，但发现代码因缺乏良好的结构而不易于进行更改，那就先重构那个程序使其比较容易添加该特性，然后再添加该特性。“南辕北辙”不一定是错的，向北走十米，扫了一辆共享单车，再向南1km更快
- 对于性能问题的担心：一般来讲影响是微乎其微，只要是能接受的性能下降，可以接受
- 事不过三：相似的需求到了第三次，就要考虑下一次能不能更快了
- 避免大兴土木，渐进式：设置兼容层
- 如果重构比重写复杂，那重写吧

重构技巧：

- 拆分阶段
- switch用多态重构
- ...

> 技巧有很多，多学习多分享，可以参考 https://book.douban.com/subject/30468597/

