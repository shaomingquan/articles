---
date: 2022-01-01
tags: 软件
---

> 服务迁移本身并不是一个难事，不过其中的细节是比较多的，能做和能做好差的比较多。身为伪全栈，我也有幸主导过几次服务迁移，它们之间有一些共性，遂有些经验可以记录一下。

## 背景

刚入职的时候，我在另外一个组，当时组里有个node+mongo的项目，后来转组后owner还是我，不过机器和数据库还在用之前那个组的配额。转眼两年，上头要求把服务和数据迁走。这是我最近一次的服务迁移经历。

## 需要提前整理的信息

主要是依赖的梳理：

- 依赖
    - 调用其他服务情况
    - 数据 & 资源
- 被依赖
    - 作为依赖被其他服务调用
    - 是否有前端

需要当前服务器上的流量情况，需要了解：

- 上游对于不同总类的流量，具体反向代理的情况
- 对于web应用，可能在机器上的主要就是：
    - 部分静态资源
    - xhr
- 可能有一些外部流量，那些无需关心

基于上述的梳理，接下来要做的事有：

- 检查依赖的连通性，真的可能ping不通
- 提前准备一些资源迁移的脚本
- 新服务部署，本机代理测试

## 不停机方案的主要技巧

资源双写，差量迁移。可以保持增量一致，后续再找齐数据差量。

把老机器上的服务改成一个指向新服务的反向代理，找齐数据差量，check数据，停写老数据。

直到上一步，资源和服务就算是迁移完成了，经历一些用户流量的check，这时候**可以确定新服务和新资源**都没问题了，再去联系上游管域名的同学，**可以最大程度避免返工**。这也是为什么先在老机器上开个反代的原因。

## 如果非得停机

> 或者没必要不停机，比如一些内部系统，停机是一种更简单的方式

这时也没必要做双写逻辑，意味着数据要全量迁移，最好是不停机但是封堵老服务对于数据的写入，并给用户提示性的返回，并通知好被依赖方，做好调用兜底方案。
